#!/usr/bin/env bash

set -euo pipefail

LOCAL_ENV_FILE="${LOCAL_ENV_FILE:-$HOME/.zshenv_local}"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
TEMPLATE_ENV_FILE="${TEMPLATE_ENV_FILE:-$REPO_ROOT/zsh/zshenv_local_template}"

usage() {
  cat <<USAGE
Usage:
  localenv                 # fzf で変数を選んで値を表示
  localenv --set           # fzf で選んで値を更新（なければ追加）
  eval "\$(localenv --set --emit-export)"  # 現在のシェルにも反映

Options:
  --set          選択した変数の値を更新（または新規追加）
  --emit-export  export KEY=VALUE 形式を stdout に出力
  -h, --help     このヘルプを表示
USAGE
}

require_cmd() {
  local cmd="$1"
  if ! command -v "$cmd" >/dev/null 2>&1; then
    echo "Error: '$cmd' is required." >&2
    exit 1
  fi
}

ensure_file() {
  local file_path="$1"
  if [ ! -f "$file_path" ]; then
    mkdir -p "$(dirname "$file_path")"
    touch "$file_path"
  fi
}

# export KEY=VALUE 形式から KEY だけを抽出
list_keys() {
  awk '
    /^[[:space:]]*export[[:space:]]+[A-Za-z_][A-Za-z0-9_]*=/ {
      line=$0
      sub(/^[[:space:]]*export[[:space:]]+/, "", line)
      split(line, a, "=")
      print a[1]
    }
  ' "$LOCAL_ENV_FILE" | awk 'NF' | sort -u
}

get_raw_value_from_file() {
  local file_path="$1"
  local key="$2"
  awk -v target="$key" '
    /^[[:space:]]*export[[:space:]]+[A-Za-z_][A-Za-z0-9_]*=/ {
      line=$0
      sub(/^[[:space:]]*export[[:space:]]+/, "", line)
      split(line, a, "=")
      k=a[1]
      if (k == target) {
        sub(/^[^=]*=/, "", line)
        value=line
      }
    }
    END { if (length(value) > 0) print value }
  ' "$file_path"
}

strip_quotes() {
  local raw="$1"
  if [[ "$raw" =~ ^\".*\"$ ]]; then
    printf '%s' "${raw:1:${#raw}-2}"
  elif [[ "$raw" =~ ^\'.*\'$ ]]; then
    printf '%s' "${raw:1:${#raw}-2}"
  else
    printf '%s' "$raw"
  fi
}

quote_for_export() {
  local value="$1"
  printf "'%s'" "${value//\'/\'\\\'\'}"
}

has_key_in_file() {
  local file_path="$1"
  local key="$2"
  awk -v target="$key" '
    /^[[:space:]]*export[[:space:]]+[A-Za-z_][A-Za-z0-9_]*=/ {
      line=$0
      sub(/^[[:space:]]*export[[:space:]]+/, "", line)
      split(line, a, "=")
      if (a[1] == target) found=1
    }
    END { exit(found ? 0 : 1) }
  ' "$file_path"
}

upsert_key_in_file() {
  local file_path="$1"
  local key="$2"
  local value="$3"
  local quoted
  quoted="$(quote_for_export "$value")"

  if has_key_in_file "$file_path" "$key"; then
    awk -v target="$key" -v quoted="$quoted" '
      {
        if ($0 ~ /^[[:space:]]*export[[:space:]]+[A-Za-z_][A-Za-z0-9_]*=/) {
          line=$0
          sub(/^[[:space:]]*export[[:space:]]+/, "", line)
          split(line, a, "=")
          if (a[1] == target) {
            print "export " target "=" quoted
            next
          }
        }
        print $0
      }
    ' "$file_path" > "$file_path.tmp"
    mv "$file_path.tmp" "$file_path"
  else
    printf 'export %s=%s\n' "$key" "$quoted" >> "$file_path"
  fi
}

select_key() {
  local keys
  keys="$(list_keys)"

  {
    printf '[+ New variable]\n'
    printf '%s\n' "$keys"
  } | fzf --height 40% --reverse --prompt='env> '
}

confirm_update_template() {
  local key="$1"
  local answer
  read -r -p "Also add ${key} to zshenv_local_template with blank value? [y/N]: " answer
  case "$answer" in
    y|Y|yes|YES)
      return 0
      ;;
    *)
      return 1
      ;;
  esac
}

SET_MODE=0
EMIT_EXPORT=0

while [ "$#" -gt 0 ]; do
  case "$1" in
    --set)
      SET_MODE=1
      ;;
    --emit-export)
      EMIT_EXPORT=1
      ;;
    -h|--help)
      usage
      exit 0
      ;;
    *)
      echo "Unknown option: $1" >&2
      usage >&2
      exit 1
      ;;
  esac
  shift
done

require_cmd fzf
ensure_file "$LOCAL_ENV_FILE"

selected="$(select_key)" || exit 130
is_new_selection=0

if [ "$selected" = "[+ New variable]" ]; then
  is_new_selection=1
  read -r -p 'New variable name: ' key
  if [[ ! "$key" =~ ^[A-Za-z_][A-Za-z0-9_]*$ ]]; then
    echo "Error: invalid variable name: $key" >&2
    exit 1
  fi
else
  key="$selected"
fi

was_existing_before=0
if has_key_in_file "$LOCAL_ENV_FILE" "$key"; then
  was_existing_before=1
fi

raw_current="$(get_raw_value_from_file "$LOCAL_ENV_FILE" "$key" || true)"
current="$(strip_quotes "$raw_current")"

if [ "$SET_MODE" -eq 1 ]; then
  if [ -n "$current" ]; then
    read -r -p "Value for $key [$current]: " next_value
    value="${next_value:-$current}"
  else
    read -r -p "Value for $key: " value
  fi

  upsert_key_in_file "$LOCAL_ENV_FILE" "$key" "$value"
  echo "Updated: $LOCAL_ENV_FILE"

  if [ "$is_new_selection" -eq 1 ] && [ "$was_existing_before" -eq 0 ] && confirm_update_template "$key"; then
    ensure_file "$TEMPLATE_ENV_FILE"
    upsert_key_in_file "$TEMPLATE_ENV_FILE" "$key" ""
    echo "Updated: $TEMPLATE_ENV_FILE"
  fi
else
  value="$current"
fi

if [ "$EMIT_EXPORT" -eq 1 ]; then
  printf 'export %s=%s\n' "$key" "$(quote_for_export "$value")"
else
  printf '%s=%s\n' "$key" "$value"
fi
